"use strict";var app=angular.module("b2gQaDashboardApp",["ngAnimate","ngRoute","ngSanitize","ui.bootstrap","angular-toArrayFilter","elasticsearch","angularChart","services","constants"]);app.config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html"}).otherwise({redirectTo:"/"})}]),app.config(["$httpProvider",function(a){a.defaults.useXDomain=!0,delete a.defaults.headers.common["X-Requested-With"]}]);var ONE_DAY=864e5,ONE_WEEK=7*ONE_DAY;angular.module("constants",[]).constant("ONE_DAY",ONE_DAY).constant("ONE_WEEK",ONE_WEEK).constant("AGE_RANGES",[0,2,4]),angular.module("config",[]).constant("config",{databases:{bugs:{host:"https://esfrontline.bugzilla.mozilla.org",index:"public_bugs",type:"bug_version"}},bugtracker:{host:"https://bugzilla.mozilla.org/"}}),angular.module("b2gQaDashboardApp").factory("weeklyChartCommons",["config","ONE_WEEK","filters",function(a,b,c){function d(a){var b=new Date(a),c=b.getDate()-b.getDay();return b.setDate(c),b.setHours(0),b.setMinutes(0),b.setSeconds(0),b.setMilliseconds(0),+b}function e(a){var b=0;for(var c in a){var d=a[c];if(!d.hasEverBeenResolved()){b=g;break}b<d.lastResolvedOn&&(b=d.lastResolvedOn)}return b}function f(a){var c=g,f=e(a);return f!==g&&(c=d(f)+b),c}var g=Date.now(),h={};return h.initializeDataset=function(){return{schema:[{name:"weekDay",type:"datetime",format:" "}],records:[]}},h.initializeOptions=function(){return{rows:[],xAxis:{name:"weekDay",displayFormat:"%Y-%m-%d"},yAxis:{label:"Bugs count"},subchart:{show:!0}}},h.generateSortedResultsAndUpdateChart=function(a,b,c){h.clearChart(a.chartData),a.sortedResults=h.buildSortedResults(a.filteredResults,c),h.buildChart(a.sortedResults,a.chartData,a.chartOptions,b)},h.clearChart=function(a){a.records.length=0},h.buildSortedResults=function(a,c){for(var e={},g=a[Object.keys(a)[0]]||{},h=d(g.createdOn),i=f(a);i>=h;)e[h]=c(h),h+=b;return e},h.buildChart=function(a,b,c,d){d.forEach(function(a){c.rows.push({name:a,type:"bar"})}),Object.keys(a).forEach(function(c){var e=parseInt(c),f={weekDay:new Date(e)};d.forEach(function(b){f[b]=a[e][b].length}),b.records.push(f)})},h.onclick=function(a,b){var d=+a.x,e=a.name;c.selected.bugsIds=b.sortedResults[d][e],b.$apply()},h.linkColors=function(a,b){var c={},d=0;return a.forEach(function(a){c[a]=b[d],d++}),c},h}]),angular.module("b2gQaDashboardApp").controller("GoToBugzillaCtrl",["$scope","bugzilla",function(a,b){a.go=function(){var c=[];for(var d in a.filteredResults){var e=a.filteredResults[d];c.push(e.id)}b.open(c)}}]),angular.module("b2gQaDashboardApp").service("filters",function(){function a(){d.versions=angular.copy(c.versions),d.bugsIds=[]}function b(a,b){var d=c[a];"undefined"==typeof d&&(d=[]),-1===d.indexOf(b)&&d.push(b)}var c={versions:[]},d={};a();var e=function(c){for(var d in c){var e=c[d];b("versions",e.getVersion())}a()};return{available:c,selected:d,generateAvailable:e,clearSelected:a}}),angular.module("b2gQaDashboardApp").controller("VersionFilterCtrl",["$scope","filters",function(a,b){a.availableFilters=b.available,a.selectedFilters=b.selected,a.toggleSelection=function(b){var c=angular.copy(a.selectedFilters.versions),d=a.selectedFilters.versions.indexOf(b);d>-1?c.splice(d,1):c.push(b),a.selectedFilters.versions=c}}]),angular.module("b2gQaDashboardApp").controller("BugsIdsFilterCtrl",["$scope","filters",function(a,b){a.availableFilters=b.available,a.selectedFilters=b.selected,a.$watch("bugsIds",function(b,c){if("undefined"!=typeof b){var d=b.split(","),e=[],f=!1;d.some(function(a){var b=parseInt(a);return isNaN(a)||isNaN(b)?""!==a&&(f=!0):e.push(b),f}),f?a.bugsIds=c:a.selectedFilters.bugsIds=e}}),a.$watchCollection("selectedFilters.bugsIds",function(){"undefined"!=typeof a.selectedFilters.bugsIds&&(a.bugsIds=a.selectedFilters.bugsIds.join(", "))})}]),angular.module("b2gQaDashboardApp").controller("ClearFiltersCtrl",["$scope","filters",function(a,b){a.clear=function(){b.clearSelected()}}]),angular.module("b2gQaDashboardApp").controller("SmoketestsCtrl",["$scope","config","SmoketestsBugsRequest","filters",function(a,b,c,d){function e(b){b.execute().then(function(){a.smoketests=b.results,a.filteredResults=a.smoketests,d.generateAvailable(a.smoketests)})}function f(){a.filteredResults={};for(var b in a.smoketests){var c=a.smoketests[b];a.selectedFilters.versions.length>0&&-1!==a.selectedFilters.versions.indexOf(c.getVersion())&&(a.filteredResults[b]=c),a.selectedFilters.bugsIds.length>0&&-1===a.selectedFilters.bugsIds.indexOf(c.id)&&delete a.filteredResults[b]}}a.smoketests={},a.filteredResults={},a.selectedFilters=d.selected,e(new c),a.$watchCollection("selectedFilters",f),a.filter=function(a){d.selected.bugsIds=[a.id]}}]),angular.module("b2gQaDashboardApp").controller("SmoketestsOpenResolvedCtrl",["$scope","weeklyChartCommons",function(a,b){function c(b){var c={};d.forEach(function(a){c[a]=[]});for(var e in a.filteredResults){var f=a.filteredResults[e];f.wasOpenDuringWeek(b)&&c[d[0]].push(f.id),f.hasBeenResolvedDuringWeek(b)&&c[d[1]].push(f.id)}return c}var d=["Open","Resolved"];a.chartData=b.initializeDataset(),a.chartOptions=b.initializeOptions(),a.chartOptions.onclick=function(c){b.onclick(c,a)},a.chartOptions.colors=b.linkColors(d,["orange","green"]),a.$watch("filteredResults",function(){b.generateSortedResultsAndUpdateChart(a,d,c)})}]),angular.module("b2gQaDashboardApp").controller("SmoketestsAgeCtrl",["$scope","IntervalsObject","AGE_RANGES","weeklyChartCommons",function(a,b,c,d){function e(d){var e=new b(c,"business days");for(var f in a.filteredResults){var g=a.filteredResults[f];if(g.wasOpenDuringWeek(d)){var h=g.getAgeInDaysAt(d);e.addContent(h,g.id)}}return e}var f=Object.keys(new b(c,"business days"));a.chartData=d.initializeDataset(),a.chartOptions=d.initializeOptions(),a.chartOptions.onclick=function(b){d.onclick(b,a)},a.chartOptions.groups=[f],a.chartOptions.colors=d.linkColors(f,["green","orange","red"]),a.$watch("filteredResults",function(){d.generateSortedResultsAndUpdateChart(a,f,e)})}]),Date.getWorkingDaysBetween=function(a,b){var c=new Date(a),d=new Date(b),e=0;if(d>c){var f=d-c;e=Math.floor(f/ONE_DAY);var g=Math.floor(e/7);e-=2*g;var h=c.getDay(),i=d.getDay();h-i>1&&(e-=2),0===h&&6!==i&&(e-=1)}return e>=0?e:0},angular.module("models",[]),angular.module("models").factory("Bug",["ONE_WEEK",function(a){var b=-1,c="nobody@mozilla.org",d=function(a,d,e,f,g,h,i,j,k,l,m,n){this.id=a||0,this.summary=d||"",this.product=e||"",this.component=f||"",this.status=g||"unconfirmed",this.resolution=h||"---",this.createdOn=i||b,this.lastResolvedOn=j||b,this.keywords=k||[],this.blockingB2G=l||"---",this.assignedTo=m||c,this.expiresOn=n||9999999999e3,this.status="new"===this.status&&this.assignedTo!==c?"assigned":this.status};return d.prototype.wasOpenDuringWeek=function(b){var c=b-a;return this.hasBeenCreatedSince(b)&&!this.hasBeenResolvedSince(c)},d.prototype.hasBeenResolvedDuringWeek=function(b){var c=b-a;return this.hasBeenResolvedSince(b)&&!this.hasBeenResolvedSince(c)},d.prototype.hasBeenCreatedSince=function(a){return this.createdOn<=a},d.prototype.hasBeenResolvedSince=function(a){return this.hasEverBeenResolved()&&this.lastResolvedOn<=a},d.prototype.getAgeInDaysAt=function(a){var b=this.hasBeenResolvedSince(a)?this.lastResolvedOn:a;return Date.getWorkingDaysBetween(this.createdOn,b)},d.prototype.getAgeInDays=function(){return this.getAgeInDaysAt(Date.now())},d.prototype.hasEverBeenResolved=function(){return this.lastResolvedOn>b},d.prototype.getVersion=function(){var a=this.blockingB2G.slice(-1);return-1===["+","?"].indexOf(a)?this.blockingB2G:this.blockingB2G.slice(0,-1)},d}]),angular.module("models").factory("IntervalsObject",function(){function a(a,b,c){var d=a[b];return d+=b===a.length-1?"+":"-"+a[b+1],d+=" "+c}function b(a){var b=a.split(" "),c=b[0].split("-"),d=c[0].replace("+","")||0,e=c[1]||Number.POSITIVE_INFINITY;return[d,e]}var c=function(b,c){for(var d=0;d<b.length;d++){var e=a(b,d,c);this[e]=[]}};return c.prototype.addContent=function(a,c){for(var d in this){var e=b(d),f=e[0],g=e[1];a>=f&&g>a&&this[d].push(c)}},c}),angular.module("services",["constants","config","models"]),angular.module("services").factory("bugzilla",["config",function(a){var b={};return b.open=function(b){var c=1===b.length?"show_bug.cgi?id=":"buglist.cgi?bug_id=";window.open(a.bugtracker.host+c+b.join("%2C"))},b}]),angular.module("services").factory("Base",["config","$q",function(a,b){function c(a,b,c){return this.index=a||"",this.type=b||"",this.body=c||{},this.results=[],this}return c.prototype.execute=function(){var c=this,d=a.databases.bugs.host+"/"+this.index+"/"+this.type+"/_search",e=b.defer(),f=new XMLHttpRequest;return f.open("POST",d),f.onload=function(){var a=JSON.parse(f.response),b=[];a.hits.hits.forEach(function(a){b.push(a._source)}),c.results=b,e.resolve(a)},f.send(JSON.stringify(this.body)),e.promise},c}]),angular.module("services").factory("BugsRequest",["Base","config","Bug",function(a,b,c){function d(){return a.apply(this,arguments),this.index=b.databases.bugs.index,this.type=b.databases.bugs.type,this.body={sort:[{bug_id:{order:"asc"}}],query:{filtered:{query:{match_all:{}},filter:{and:[{range:{expires_on:{gte:Date.now()}}}]}}},from:0,size:2e5},this}return d.prototype=new a,d.prototype.execute=function(){var b=this,d=a.prototype.execute.apply(this,arguments);return d.then(function(a){var d={};return b.results.forEach(function(a){d[a.bug_id]=new c(a.bug_id,a.short_desc,a.product,a.component,a.bug_status,a.resolution,a.created_ts,a.cf_last_resolved,a.keywords,a.cf_blocking_b2g,a.assigned_to,a.expires_on)}),b.results=d,a})},d}]),angular.module("services").factory("SmoketestsBugsRequest",["BugsRequest",function(a){function b(){return a.apply(this,arguments),this.body.query.filtered.filter.and.push({term:{keywords:"smoketest"}},{exists:{field:"cf_blocking_b2g"}},{not:{terms:{cf_blocking_b2g:["---","-"]}}}),this}return b.prototype=new a,b}]),angular.module("services").service("elasticsearch",["esFactory","config",function(a,b){return a({host:b.databases.bugs.host})}]);